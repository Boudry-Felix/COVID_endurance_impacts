---
title: "R Notebook"
author: "Félix Boudry"
date: "`r Sys.Date()`"
output:
    html_notebook:
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  error = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 12,
  fig.height = 6
)

# Import packages
library(rmarkdown)
library(tidyverse)
library(plyr)
library(janitor)
library(psych)
library(DTWBI)
library(stringi)
library(TraMineR)
library(reshape2)
library(cluster)
library(gtsummary)
library(ggpubr)
library(DT)
source(file = "Functions.R") # Import own functions
```

```{r Import}
# Import data sets
my_var <- "endurance_sport"
col_questions <- read.csv(file = "Data/col_question.csv")
analysis_data <- read.csv(file = "Data/Answers_completed.csv") %>% 
  `colnames<-`(col_questions$col_name) %>% 
  clean_names() %>% 
  remove_empty(which = c("rows", "cols")) %>% 
  select(-any_of("other_medication"))
```

```{r Compute}
# Compute new useful variables
analysis_data$duration_to_training_binary <-
  analysis_data$duration_to_training %>%
  stri_replace_all_regex(
    pattern = c(
      "Reprise immédiate|Quelques jours après",
      ".*mois.*|.*semaine.*"
    ),
    replacement = c("court", "long"),
    vectorize_all = FALSE
  )

analysis_data$difficulties_duration_binary <-
  analysis_data$difficulties_duration %>%
  stri_replace_all_regex(
    pattern = c("Aucune|1 semaine",
                ".*mois.*|.*semaine.*"),
    replacement = c("court", "long"),
    vectorize_all = FALSE
  )

analysis_data$time_to_normal_training_volume_binary <-
  analysis_data$time_to_normal_training_volume %>%
  stri_replace_all_regex(
    pattern = c("1 semaine|1 moins",
                ".*mois.*|.*semaine.*"),
    replacement = c("court", "long"),
    vectorize_all = FALSE
  )

analysis_data$modified_training_volume_binary <-
  analysis_data$modified_training_volume %>%
  stri_replace_all_regex(
    pattern = c(".*diminished.*",
                ".*augmented.*|.*no*"),
    replacement = c("diminished", "augmented/unchanged"),
    vectorize_all = FALSE
  )

# Encode answers as labels
analysis_data_endcoded <-
  df_encode(input = analysis_data) # Create a data set with labeled data
```

```{r Statistics}
stat_results <- mapply(
  FUN = function(my_columns, my_colnames) {
    # Check number of possible answer to determine test
    answer_profile <-
      my_columns %>% unique() %>% na.omit() %>% length()
    usable_table <-
      na.omit(analysis_data[, c(my_var, my_colnames)])[[my_var]] %>%
      unique() %>% length()
    if (answer_profile < 2 && usable_table < 2) {
      return(NA)
    } else if (answer_profile == 2 && usable_table > 1) {
      # Compute chi2 statistics
      prop_stats(input = analysis_data,
                 var1 = my_colnames,
                 var2 = my_var)
    } else if (answer_profile > 2 && usable_table > 1) {
      # Compute ANOVA statistics
      anova_stats(input = analysis_data,
                  var1 = my_colnames,
                  var2 = my_var)
    } else {
      return(NA)
    }
  },
  my_columns = analysis_data,
  my_colnames = names(analysis_data)
)
```

```{r Descriptive}
# Analysis based on simple statistics and plots
descriptive_results <- mapply(
  FUN = function(my_columns, my_colnames) {
    # Check number of possible answer to determine plots
    answer_profile <-
      my_columns %>% unique() %>% na.omit() %>% length()
    usable_table <-
      na.omit(analysis_data[, c(my_var, my_colnames)])[[my_var]] %>%
      unique() %>% length()
    if (answer_profile < 2 && usable_table < 2) {
      # Only count answer if no groups
      my_count <-
        my_var_counting(input = analysis_data, my_vars = my_colnames) %>%
        getElement(name = my_colnames)
      return(lst(my_count))
    } else if (answer_profile == 2 && usable_table > 1) {
      # Optimized plots for double bar plots
      my_count <-
        my_var_counting(input = analysis_data, my_vars = my_colnames) %>%
        getElement(name = my_colnames)
      my_plot <-
        bar_plot_multi(input = analysis_data, my_columns = my_colnames) %>%
        getElement(name = my_colnames)
      return(lst(my_count, my_plot))
    } else if (answer_profile > 2 && usable_table > 1) {
      # Optimizes plots for multiple bar plots
      my_count <-
        my_var_counting(input = analysis_data, my_vars = my_colnames) %>%
        getElement(name = my_colnames)
      my_plot <-
        bar_plot_multi(input = analysis_data, my_columns = my_colnames) %>%
        getElement(name = my_colnames)
      return(lst(my_count, my_plot))
    } else {
      return(NA)
    }
  },
  my_columns = analysis_data,
  my_colnames = names(analysis_data)
)

descriptive_plots <- # Put all plots in a new list
  lapply(descriptive_results[!is.na(descriptive_results)], "[[", "my_plot") %>%
  discard(is.null)
descriptive_values <- # Put all counts in a new list
  lapply(descriptive_results[!is.na(descriptive_results)], "[[", "my_count") %>%
  discard(is.null)
```

# Population description

## Anthropometrics

Presentation of the population studied.

In the population kept in this study there are
**`r descriptive_values$sex$feminin`** womens and
**`r descriptive_values$sex$masculin`** mens and all of the
**`r nrow(analysis_data)`** subjects were infected by COVID-19.

```{r Anthropometrics}
analysis_data$covid_test %>% count() %>% my_table(col.names = c("Tests", "freq"))
describe(analysis_data[c("age", "height", "weight")], skew = FALSE) %>%
  round(digits = 1) %>% t() %>% my_table()
hist_plot_multi(input = analysis_data,
                my_columns = c("age", "height", "weight")) %>%
  ggarrange(plotlist = ., ncol = 3, nrow = 1)
```

## Training

```{r Training}
descriptive_plots[c("endurance_sport", "federal_license")] %>%
  ggarrange(plotlist = ., nrow = 1, ncol = 2)
walk(descriptive_plots[c("train_volume", "train_sessions_week", "train_method")], print)
descriptive_plots$what_sport +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
```

In the studied population, **`r descriptive_values$endurance_sport$oui`** are endurance
trained athletes.

## Professions

Subject's professions are shown below:

```{r Professions}
descriptive_plots$profession
```

## Pathologies

**`r count(analysis_data$pathology)[2, 2]`** have a known pathology.

```{r Pathologies}
descriptive_plots$pathology_description +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
descriptive_plots$pathology_medication
```

# COVID impact on training

## COVID

### Symptoms

```{r COVID symptoms}
descriptive_plots[c(
  "cough",
  "fever",
  "runny_nose",
  "headache",
  "sore_throat",
  "tired",
  "muscular_pain",
  "vomiting",
  "diarrhea",
  "breathlessness",
  "respiratory_difficulties",
  "other_symptoms"
)] %>%
  ggarrange(plotlist = ., ncol = 2, nrow = 2) %>% 
  walk(print)
```

## Post COVID

### Symptoms

Binary : Reprise immédiate et quelques jours après = court; le reste = long

```{r Post COVID symptoms}
descriptive_plots[c("after_symptoms", "duration_to_training_binary")] %>%
  ggarrange(plotlist = ., ncol = 2, nrow = 1)
descriptive_plots$duration_to_training
descriptive_plots[c(
  "after_cough",
  "after_runny_nose",
  "after_headache",
  "after_sore_throat",
  "after_tired",
  "after_muscular_pain",
  "after_vomiting",
  "after_diarrhea",
  "after_breathlessness",
  "after_respiratory_difficulties"
)] %>%
  ggarrange(plotlist = ., ncol = 2, nrow = 2) %>% 
  walk(print)
```

### Impact during training

```{r Post COVID impact}
descriptive_plots[c(
  "training_tired",
  "training_respiratory_difficulties",
  "training_muscular_pain",
  "training_concentration_difficulties"
)] %>%
  ggarrange(plotlist = ., ncol = 2, nrow = 2)
descriptive_plots[c(
  "training_tired_note",
  "training_respiratory_difficulties_note",
  "training_muscular_pain_note",
  "training_concentration_difficulties_note"
)] %>% walk(print)
descriptive_plots$difficulties_duration +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
descriptive_plots$difficulties_duration_binary
descriptive_plots$difficulties_duration
descriptive_plots[c(
  "restart_training_medication",
  "respiratory_medication",
  "cortisone_medication",
  "vitamin_medication",
  "medication_duration"
)] %>%
  ggarrange(plotlist = ., ncol = 2, nrow = 2) %>% 
  walk(print)
```

Binary : Aucun et 1 semaine = court et le reste = long

### Training difficulties

```{r Training difficulties}
descriptive_plots[c(
  "high_intensity_training",
  "force_training",
  "endurance_training",
  "intermittent_training",
  "other_training"
)] %>%
  ggarrange(plotlist = ., ncol = 2, nrow = 2) %>% 
  walk(print)
descriptive_plots[c(
  "longer_recuperation",
  "training_volume_back_normal",
  "modified_training_volume_binary"
)] %>%
  ggarrange(plotlist = ., ncol = 2, nrow = 2)
descriptive_plots[c(
  "modified_training_volume",
  "time_to_normal_training_volume",
  "endurance_training_more_difficult"
)] %>% walk(print)
```

Binary : Jusqu'à 1 mois = court; le reste = long

### Hypoxia training

```{r Hypoxia training}
descriptive_plots[c(
  "hypoxia_training",
  "after_hypoxia_training",
  "500-2000_hypoxia",
  "2000-3000_hypoxia",
  "3000-5500_hypoxia",
  "hypoxia_difficulties",
  "hypoxia_respiratory_difficulties"
)] %>%
  ggarrange(plotlist = ., ncol = 2, nrow = 2) %>% 
  walk(print)
```

# Answer profiles

```{r Time series}
my_profiles <- lst()
data_profiles <-
  analysis_data_endcoded$encoded_data %>%
  select_if(~ !any(is.na(.))) %>%
  select(
    -c(
      adult,
      profession,
      age,
      height,
      weight,
      pathology,
      pathology_description,
      pathology_medication,
      region,
      what_sport,
      train_volume,
      train_method,
      train_sessions_week,
      covid_positive,
      covid_test,
      covid_date,
      covid_duration,
      covid_type,
      covid_how_much,
      after_fever,
      medication_duration,
      restart_training,
      # hypoxia_difficulties_detail,
      hypoxia_duration,
      difficulties_duration,
      duration_to_training,
      # other_medication,
      time_to_normal_training_volume
      # training_concentration_difficulties_note,
      # training_muscular_pain_note,
      # training_respiratory_difficulties_note,
      # training_tired_notes
    )
  )
data_profiles_derived <- local.derivative.ddtw(data_profiles)

chains <-
  unite(data = data_profiles, col = "chains", sep = "-") %>%
  seqdef()
```

```{r Time series plots}
# Plots -------------------------------------------------------------------
# Create chain plots
matplot(t(data_profiles), type = 'l')
simple_chain_plot <- recordPlot()
matplot(t(data_profiles_derived), type = 'l')
derived_chain_plot <- recordPlot()

plot_data <-
  data_profiles %>%
  rownames_to_column() %>%
  gather(colname, value, -rowname)

factor_tile_plot <- ggplot(plot_data) +
  geom_tile(aes(x = colname, y = rowname, fill = factor(value))) +
  scale_fill_brewer(palette = 10)
factor_tile_plot

tile_plot <- ggplot(plot_data) +
  geom_tile(aes(x = colname, y = rowname, fill = value))

seqIplot(chains)
chain_graph <- recordPlot()

my_transitions <-
  seqtrate(seqdata = chains, sel.states = NULL) %>% round(digits = 2) %>% melt()

transition_plot <- ggplot(my_transitions, aes(Var2, Var1)) +
  geom_tile(aes(fill = value)) +
  geom_text(aes(label = round(value, 2))) +
  scale_fill_continuous(high = "#132B43",
                        low = "#56B1F7",
                        name = "Transitions")

sub_cost <-
  seqsubm(chains, method = "TRATE") %>% round(digits = 2) %>% melt()

sub_cost_plot <- ggplot(sub_cost, aes(Var2, Var1)) +
  geom_tile(aes(fill = value)) +
  geom_text(aes(label = round(value, 2))) +
  scale_fill_continuous(high = "#132B43",
                        low = "#56B1F7",
                        name = "Substitution rate")

dissim <-
  seqdist(
    chains,
    method = "OM",
    sm = seqsubm(chains, method = "TRATE"),
    indel = 1
  ) %>% round(digits = 2) %>%  melt()

dissim_plot <- ggplot(dissim, aes(Var2, Var1)) +
  geom_tile(aes(fill = value)) +
  # geom_text(aes(label = round(value, 2))) +
  scale_fill_continuous(high = "#132B43",
                        low = "#56B1F7",
                        name = "Dissimilarities")

dissim_cluster <-
  seqdist(
    chains,
    method = "OM",
    sm = seqsubm(chains, method = "TRATE"),
    indel = 1
  ) %>% agnes(diss = TRUE, method = "ward")

as.dendrogram(dissim_cluster) %>% plot(type = "rectangle")
clust_plot <- recordPlot()

analysis_data$clust <- cutree(dissim_cluster, k = 2)
cluster_caract <- tbl_summary(analysis_data, by = clust) %>% 
  add_p()

# Structure ---------------------------------------------------------------
# Structure data
chains_plots <-
  lst(
    simple_chain_plot,
    derived_chain_plot,
    factor_tile_plot,
    tile_plot,
    chain_graph,
    transition_plot,
    sub_cost_plot,
    dissim_plot,
    clust_plot,
    cluster_caract
  )
```

```{r Profiles}
chains_plots$simple_chain_plot
chains_plots$derived_chain_plot
chains_plots$factor_tile_plot
chains_plots$tile_plot
chains_plots$chain_graph
chains_plots$transition_plot
chains_plots$sub_cost_plot
chains_plots$dissim_plot
chains_plots$clust_plot
chains_plots$cluster_caract
```

# Annexes

```{r Annexes}
questions <-
  lapply(col_questions,
         gsub,
         pattern = "_",
         replacement = " ") %>% as.data.frame()
datatable(questions)
```
